// ============================================
// SISTEMA DE INFORMACIÓN ACADÉMICA
// Prisma Schema para MySQL 8.0
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// MÓDULO: GESTIÓN DE USUARIOS Y ROLES
// ============================================

/// Tabla principal de usuarios del sistema
model User {
  id                Int       @id @default(autoincrement()) @db.UnsignedInt
  email             String    @unique @db.VarChar(150)
  passwordHash      String    @map("password_hash") @db.VarChar(255)
  firstName         String    @map("first_name") @db.VarChar(100)
  lastName          String    @map("last_name") @db.VarChar(100)
  phone             String?   @db.VarChar(20)
  profileImageUrl   String?   @map("profile_image_url") @db.VarChar(500)
  isActive          Boolean   @default(true) @map("is_active")
  emailVerified     Boolean   @default(false) @map("email_verified")
  lastLoginAt       DateTime? @map("last_login_at") @db.DateTime
  createdAt         DateTime  @default(now()) @map("created_at") @db.DateTime
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.DateTime
  deletedAt         DateTime? @map("deleted_at") @db.DateTime

  // Relaciones
  roles                UserRole[]
  student              Student?
  teacher              Teacher?
  guardian             Guardian?
  certificatesIssued   Certificate[]             @relation("CertificateIssuer")
  paymentsReceived     PaymentRecord[]           @relation("PaymentReceiver")
  cashRegistersOpened  CashRegister[]            @relation("CashRegisterOpener")
  cashRegistersClosed  CashRegister[]            @relation("CashRegisterCloser")
  cashFlowsCreated     CashFlow[]
  notificationLogs     NotificationEmailLog[]

  @@index([email])
  @@index([isActive])
  @@map("users")
}

/// Catálogo de roles del sistema
model Role {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  name        String   @unique @db.VarChar(50)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.DateTime

  // Relaciones
  users UserRole[]

  @@map("roles")
}

/// Tabla intermedia N:M entre User y Role
model UserRole {
  id         Int      @id @default(autoincrement()) @db.UnsignedInt
  userId     Int      @map("user_id") @db.UnsignedInt
  roleId     Int      @map("role_id") @db.UnsignedInt
  assignedAt DateTime @default(now()) @map("assigned_at") @db.DateTime

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// ============================================
// MÓDULO: ACTORES DEL SISTEMA
// ============================================

/// Estudiantes inscritos en el instituto
model Student {
  id                     Int       @id @default(autoincrement()) @db.UnsignedInt
  userId                 Int       @unique @map("user_id") @db.UnsignedInt
  documentType           String    @map("document_type") @db.VarChar(20)
  documentNumber         String    @map("document_number") @db.VarChar(20)
  dateOfBirth            DateTime  @map("date_of_birth") @db.Date
  gender                 String?   @db.VarChar(10)
  address                String?   @db.VarChar(255)
  schoolId               Int?      @map("school_id") @db.UnsignedInt
  emergencyContactName   String?   @map("emergency_contact_name") @db.VarChar(150)
  emergencyContactPhone  String?   @map("emergency_contact_phone") @db.VarChar(20)
  medicalNotes           String?   @map("medical_notes") @db.Text
  enrollmentStatus       String    @default("ACTIVE") @map("enrollment_status") @db.VarChar(20)
  createdAt              DateTime  @default(now()) @map("created_at") @db.DateTime
  updatedAt              DateTime  @updatedAt @map("updated_at") @db.DateTime
  deletedAt              DateTime? @map("deleted_at") @db.DateTime

  // Relaciones
  user             User              @relation(fields: [userId], references: [id], onDelete: Restrict)
  school           School?           @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  guardians        StudentGuardian[]
  enrollments      Enrollment[]
  debtRecords      DebtRecord[]

  @@index([userId])
  @@index([documentNumber])
  @@index([schoolId])
  @@index([enrollmentStatus])
  @@map("students")
}

/// Padres o tutores legales
model Guardian {
  id             Int       @id @default(autoincrement()) @db.UnsignedInt
  userId         Int       @unique @map("user_id") @db.UnsignedInt
  documentType   String    @map("document_type") @db.VarChar(20)
  documentNumber String    @map("document_number") @db.VarChar(20)
  relationship   String    @db.VarChar(50)
  occupation     String?   @db.VarChar(100)
  workplace      String?   @db.VarChar(150)
  createdAt      DateTime  @default(now()) @map("created_at") @db.DateTime
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.DateTime
  deletedAt      DateTime? @map("deleted_at") @db.DateTime

  // Relaciones
  user     User              @relation(fields: [userId], references: [id], onDelete: Restrict)
  students StudentGuardian[]

  @@index([userId])
  @@index([documentNumber])
  @@map("guardians")
}

/// Tabla intermedia N:M entre Student y Guardian
model StudentGuardian {
  id         Int      @id @default(autoincrement()) @db.UnsignedInt
  studentId  Int      @map("student_id") @db.UnsignedInt
  guardianId Int      @map("guardian_id") @db.UnsignedInt
  isPrimary  Boolean  @default(false) @map("is_primary")
  canPickup  Boolean  @default(true) @map("can_pickup")
  createdAt  DateTime @default(now()) @map("created_at") @db.DateTime

  // Relaciones
  student  Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  guardian Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)

  @@unique([studentId, guardianId])
  @@index([studentId])
  @@index([guardianId])
  @@map("student_guardians")
}

/// Docentes/capacitadores del instituto
model Teacher {
  id             Int       @id @default(autoincrement()) @db.UnsignedInt
  userId         Int       @unique @map("user_id") @db.UnsignedInt
  documentType   String    @map("document_type") @db.VarChar(20)
  documentNumber String    @map("document_number") @db.VarChar(20)
  specialization String?   @db.VarChar(150)
  hireDate       DateTime  @map("hire_date") @db.Date
  contractType   String    @map("contract_type") @db.VarChar(20)
  hourlyRate     Decimal?  @map("hourly_rate") @db.Decimal(10, 2)
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at") @db.DateTime
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.DateTime
  deletedAt      DateTime? @map("deleted_at") @db.DateTime

  // Relaciones
  user             User          @relation(fields: [userId], references: [id], onDelete: Restrict)
  groups           Group[]
  attendances      Attendance[]  @relation("AttendanceRecorder")
  grades           Grade[]       @relation("GradeRecorder")
  reportCards      ReportCard[]  @relation("ReportCardIssuer")

  @@index([userId])
  @@index([documentNumber])
  @@index([isActive])
  @@map("teachers")
}

// ============================================
// MÓDULO: ESTRUCTURA ACADÉMICA
// ============================================

/// Programas académicos ofrecidos
model Course {
  id             Int      @id @default(autoincrement()) @db.UnsignedInt
  name           String   @db.VarChar(150)
  code           String   @unique @db.VarChar(20)
  description    String?  @db.Text
  minAge         Int      @map("min_age")
  maxAge         Int      @map("max_age")
  durationMonths Int?     @map("duration_months")
  imageUrl       String?  @map("image_url") @db.VarChar(500)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at") @db.DateTime
  updatedAt      DateTime @updatedAt @map("updated_at") @db.DateTime

  // Relaciones
  levels Level[]

  @@index([code])
  @@index([isActive])
  @@map("courses")
}

/// Niveles dentro de un curso
model Level {
  id            Int      @id @default(autoincrement()) @db.UnsignedInt
  courseId      Int      @map("course_id") @db.UnsignedInt
  name          String   @db.VarChar(100)
  code          String   @db.VarChar(20)
  orderIndex    Int      @map("order_index")
  description   String?  @db.Text
  durationWeeks Int      @map("duration_weeks")
  totalHours    Int      @map("total_hours")
  basePrice     Decimal  @map("base_price") @db.Decimal(10, 2)
  objectives    String?  @db.Text
  requirements  String?  @db.Text
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.DateTime
  updatedAt     DateTime @updatedAt @map("updated_at") @db.DateTime

  // Relaciones
  course Course  @relation(fields: [courseId], references: [id], onDelete: Restrict)
  groups Group[]

  @@unique([courseId, code])
  @@index([courseId])
  @@index([isActive])
  @@map("levels")
}

/// Instancias concretas de un nivel en un periodo
model Group {
  id              Int      @id @default(autoincrement()) @db.UnsignedInt
  levelId         Int      @map("level_id") @db.UnsignedInt
  teacherId       Int      @map("teacher_id") @db.UnsignedInt
  name            String   @db.VarChar(100)
  code            String   @unique @db.VarChar(30)
  startDate       DateTime @map("start_date") @db.Date
  endDate         DateTime @map("end_date") @db.Date
  maxCapacity     Int      @map("max_capacity")
  minCapacity     Int      @default(5) @map("min_capacity")
  currentEnrolled Int      @default(0) @map("current_enrolled")
  status          String   @default("DRAFT") @db.VarChar(20)
  classroom       String?  @db.VarChar(50)
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.DateTime
  updatedAt       DateTime @updatedAt @map("updated_at") @db.DateTime

  // Relaciones
  level       Level        @relation(fields: [levelId], references: [id], onDelete: Restrict)
  teacher     Teacher      @relation(fields: [teacherId], references: [id], onDelete: Restrict)
  schedules   Schedule[]
  enrollments Enrollment[]

  @@index([levelId])
  @@index([teacherId])
  @@index([status])
  @@index([startDate])
  @@map("groups")
}

/// Horarios de clases
model Schedule {
  id        Int      @id @default(autoincrement()) @db.UnsignedInt
  groupId   Int      @map("group_id") @db.UnsignedInt
  dayOfWeek String   @map("day_of_week") @db.VarChar(20)
  startTime DateTime @map("start_time") @db.Time
  endTime   DateTime @map("end_time") @db.Time
  createdAt DateTime @default(now()) @map("created_at") @db.DateTime

  // Relaciones
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@map("schedules")
}

// ============================================
// MÓDULO: PROCESOS ACADÉMICOS
// ============================================

/// Matrículas de estudiantes en grupos
model Enrollment {
  id                 Int       @id @default(autoincrement()) @db.UnsignedInt
  studentId          Int       @map("student_id") @db.UnsignedInt
  groupId            Int       @map("group_id") @db.UnsignedInt
  enrollmentDate     DateTime  @map("enrollment_date") @db.Date
  startDate          DateTime  @map("start_date") @db.Date
  endDate            DateTime? @map("end_date") @db.Date
  status             String    @default("PENDING") @db.VarChar(20)
  agreedPrice        Decimal   @map("agreed_price") @db.Decimal(10, 2)
  discountPercentage Decimal   @default(0.00) @map("discount_percentage") @db.Decimal(5, 2)
  agreementId        Int?      @map("agreement_id") @db.UnsignedInt
  enrollmentNotes    String?   @map("enrollment_notes") @db.Text
  createdAt          DateTime  @default(now()) @map("created_at") @db.DateTime
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.DateTime
  deletedAt          DateTime? @map("deleted_at") @db.DateTime

  // Relaciones
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Restrict)
  group        Group        @relation(fields: [groupId], references: [id], onDelete: Restrict)
  agreement    Agreement?   @relation(fields: [agreementId], references: [id], onDelete: SetNull)
  attendances  Attendance[]
  grades       Grade[]
  reportCards  ReportCard[]
  certificates Certificate[]
  invoices     Invoice[]

  @@index([studentId])
  @@index([groupId])
  @@index([status])
  @@index([enrollmentDate])
  @@index([agreementId])
  @@map("enrollments")
}

/// Registro de asistencia
model Attendance {
  id             Int       @id @default(autoincrement()) @db.UnsignedInt
  enrollmentId   Int       @map("enrollment_id") @db.UnsignedInt
  attendanceDate DateTime  @map("attendance_date") @db.Date
  status         String    @db.VarChar(20)
  arrivalTime    DateTime? @map("arrival_time") @db.Time
  notes          String?   @db.Text
  recordedBy     Int?      @map("recorded_by") @db.UnsignedInt
  createdAt      DateTime  @default(now()) @map("created_at") @db.DateTime
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.DateTime

  // Relaciones
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  recorder   Teacher?   @relation("AttendanceRecorder", fields: [recordedBy], references: [id], onDelete: SetNull)

  @@unique([enrollmentId, attendanceDate])
  @@index([enrollmentId])
  @@index([attendanceDate])
  @@index([status])
  @@map("attendances")
}

/// Calificaciones de evaluaciones
model Grade {
  id             Int      @id @default(autoincrement()) @db.UnsignedInt
  enrollmentId   Int      @map("enrollment_id") @db.UnsignedInt
  evaluationName String   @map("evaluation_name") @db.VarChar(150)
  evaluationType String   @map("evaluation_type") @db.VarChar(20)
  gradeValue     Decimal  @map("grade_value") @db.Decimal(5, 2)
  maxGrade       Decimal  @default(20.00) @map("max_grade") @db.Decimal(5, 2)
  weight         Decimal  @default(1.00) @db.Decimal(5, 2)
  evaluationDate DateTime @map("evaluation_date") @db.Date
  comments       String?  @db.Text
  recordedBy     Int?     @map("recorded_by") @db.UnsignedInt
  createdAt      DateTime @default(now()) @map("created_at") @db.DateTime
  updatedAt      DateTime @updatedAt @map("updated_at") @db.DateTime

  // Relaciones
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  recorder   Teacher?   @relation("GradeRecorder", fields: [recordedBy], references: [id], onDelete: SetNull)

  @@index([enrollmentId])
  @@index([evaluationType])
  @@index([evaluationDate])
  @@map("grades")
}

/// Boletines o actas de calificaciones
model ReportCard {
  id                   Int      @id @default(autoincrement()) @db.UnsignedInt
  enrollmentId         Int      @map("enrollment_id") @db.UnsignedInt
  periodName           String   @map("period_name") @db.VarChar(100)
  periodStart          DateTime @map("period_start") @db.Date
  periodEnd            DateTime @map("period_end") @db.Date
  finalGrade           Decimal  @map("final_grade") @db.Decimal(5, 2)
  maxGrade             Decimal  @default(20.00) @map("max_grade") @db.Decimal(5, 2)
  attendancePercentage Decimal? @map("attendance_percentage") @db.Decimal(5, 2)
  teacherComments      String?  @map("teacher_comments") @db.Text
  status               String   @db.VarChar(20)
  issuedDate           DateTime? @map("issued_date") @db.Date
  issuedBy             Int?     @map("issued_by") @db.UnsignedInt
  createdAt            DateTime @default(now()) @map("created_at") @db.DateTime
  updatedAt            DateTime @updatedAt @map("updated_at") @db.DateTime

  // Relaciones
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  issuer     Teacher?   @relation("ReportCardIssuer", fields: [issuedBy], references: [id], onDelete: SetNull)

  @@index([enrollmentId])
  @@index([status])
  @@index([issuedDate])
  @@map("report_cards")
}

/// Certificados emitidos
model Certificate {
  id                   Int      @id @default(autoincrement()) @db.UnsignedInt
  enrollmentId         Int      @map("enrollment_id") @db.UnsignedInt
  certificateNumber    String   @unique @map("certificate_number") @db.VarChar(50)
  studentName          String   @map("student_name") @db.VarChar(200)
  levelName            String   @map("level_name") @db.VarChar(150)
  courseName           String   @map("course_name") @db.VarChar(150)
  issueDate            DateTime @map("issue_date") @db.Date
  completionDate       DateTime @map("completion_date") @db.Date
  finalGrade           Decimal  @map("final_grade") @db.Decimal(5, 2)
  attendancePercentage Decimal  @map("attendance_percentage") @db.Decimal(5, 2)
  totalHours           Int      @map("total_hours")
  certificateFileUrl   String?  @map("certificate_file_url") @db.VarChar(500)
  issuedBy             Int?     @map("issued_by") @db.UnsignedInt
  notes                String?  @db.Text
  createdAt            DateTime @default(now()) @map("created_at") @db.DateTime

  // Relaciones
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Restrict)
  issuer     User?      @relation("CertificateIssuer", fields: [issuedBy], references: [id], onDelete: SetNull)

  @@index([enrollmentId])
  @@index([issueDate])
  @@map("certificates")
}

// ============================================
// MÓDULO: GESTIÓN FINANCIERA
// ============================================

/// Facturas
model Invoice {
  id                   Int       @id @default(autoincrement()) @db.UnsignedInt
  enrollmentId         Int?      @map("enrollment_id") @db.UnsignedInt
  invoiceNumber        String    @unique @map("invoice_number") @db.VarChar(30)
  issueDate            DateTime  @map("issue_date") @db.Date
  dueDate              DateTime  @map("due_date") @db.Date
  subtotal             Decimal   @db.Decimal(10, 2)
  discountAmount       Decimal   @default(0.00) @map("discount_amount") @db.Decimal(10, 2)
  taxAmount            Decimal   @default(0.00) @map("tax_amount") @db.Decimal(10, 2)
  totalAmount          Decimal   @map("total_amount") @db.Decimal(10, 2)
  amountPaid           Decimal   @default(0.00) @map("amount_paid") @db.Decimal(10, 2)
  balance              Decimal   @db.Decimal(10, 2)
  status               String    @default("PENDING") @db.VarChar(20)
  paymentDeadlineDays  Int       @default(30) @map("payment_deadline_days")
  notes                String?   @db.Text
  createdAt            DateTime  @default(now()) @map("created_at") @db.DateTime
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.DateTime
  deletedAt            DateTime? @map("deleted_at") @db.DateTime

  // Relaciones
  enrollment      Enrollment?     @relation(fields: [enrollmentId], references: [id], onDelete: SetNull)
  paymentRecords  PaymentRecord[]

  @@index([enrollmentId])
  @@index([status])
  @@index([dueDate])
  @@index([issueDate])
  @@map("invoices")
}

/// Registros de pagos
model PaymentRecord {
  id              Int        @id @default(autoincrement()) @db.UnsignedInt
  invoiceId       Int        @map("invoice_id") @db.UnsignedInt
  paymentDate     DateTime   @map("payment_date") @db.Date
  amount          Decimal    @db.Decimal(10, 2)
  paymentMethod   String     @map("payment_method") @db.VarChar(20)
  referenceNumber String?    @map("reference_number") @db.VarChar(100)
  notes           String?    @db.Text
  receivedBy      Int?       @map("received_by") @db.UnsignedInt
  createdAt       DateTime   @default(now()) @map("created_at") @db.DateTime

  // Relaciones
  invoice    Invoice    @relation(fields: [invoiceId], references: [id], onDelete: Restrict)
  receiver   User?      @relation("PaymentReceiver", fields: [receivedBy], references: [id], onDelete: SetNull)
  cashFlows  CashFlow[]

  @@index([invoiceId])
  @@index([paymentDate])
  @@index([paymentMethod])
  @@map("payment_records")
}

/// Registro de deudas por estudiante
model DebtRecord {
  id               Int       @id @default(autoincrement()) @db.UnsignedInt
  studentId        Int       @map("student_id") @db.UnsignedInt
  totalDebt        Decimal   @map("total_debt") @db.Decimal(10, 2)
  oldestDebtDate   DateTime? @map("oldest_debt_date") @db.Date
  lastPaymentDate  DateTime? @map("last_payment_date") @db.Date
  paymentPlan      String?   @map("payment_plan") @db.Text
  status           String    @db.VarChar(20)
  createdAt        DateTime  @default(now()) @map("created_at") @db.DateTime
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.DateTime

  // Relaciones
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([status])
  @@map("debt_records")
}

/// Aperturas y cierres de caja
model CashRegister {
  id              Int       @id @default(autoincrement()) @db.UnsignedInt
  openedBy        Int       @map("opened_by") @db.UnsignedInt
  openedAt        DateTime  @map("opened_at") @db.DateTime
  closedBy        Int?      @map("closed_by") @db.UnsignedInt
  closedAt        DateTime? @map("closed_at") @db.DateTime
  openingBalance  Decimal   @map("opening_balance") @db.Decimal(10, 2)
  closingBalance  Decimal?  @map("closing_balance") @db.Decimal(10, 2)
  expectedBalance Decimal?  @map("expected_balance") @db.Decimal(10, 2)
  difference      Decimal?  @db.Decimal(10, 2)
  status          String    @default("OPEN") @db.VarChar(20)
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.DateTime

  // Relaciones
  opener    User       @relation("CashRegisterOpener", fields: [openedBy], references: [id], onDelete: Restrict)
  closer    User?      @relation("CashRegisterCloser", fields: [closedBy], references: [id], onDelete: SetNull)
  cashFlows CashFlow[]

  @@index([openedBy])
  @@index([openedAt])
  @@index([status])
  @@map("cash_registers")
}

/// Movimientos de caja
model CashFlow {
  id              Int      @id @default(autoincrement()) @db.UnsignedInt
  cashRegisterId  Int      @map("cash_register_id") @db.UnsignedInt
  transactionType String   @map("transaction_type") @db.VarChar(20)
  amount          Decimal  @db.Decimal(10, 2)
  category        String   @db.VarChar(100)
  description     String?  @db.Text
  paymentRecordId Int?     @map("payment_record_id") @db.UnsignedInt
  reference       String?  @db.VarChar(100)
  createdBy       Int      @map("created_by") @db.UnsignedInt
  createdAt       DateTime @default(now()) @map("created_at") @db.DateTime

  // Relaciones
  cashRegister  CashRegister   @relation(fields: [cashRegisterId], references: [id], onDelete: Restrict)
  paymentRecord PaymentRecord? @relation(fields: [paymentRecordId], references: [id], onDelete: SetNull)
  creator       User           @relation(fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([cashRegisterId])
  @@index([transactionType])
  @@index([createdAt])
  @@map("cash_flows")
}

// ============================================
// MÓDULO: CONVENIOS INSTITUCIONALES
// ============================================

/// Colegios asociados
model School {
  id            Int       @id @default(autoincrement()) @db.UnsignedInt
  name          String    @db.VarChar(200)
  code          String    @unique @db.VarChar(30)
  address       String?   @db.VarChar(255)
  district      String?   @db.VarChar(100)
  city          String?   @db.VarChar(100)
  phone         String?   @db.VarChar(20)
  email         String?   @db.VarChar(150)
  contactPerson String?   @map("contact_person") @db.VarChar(150)
  contactPhone  String?   @map("contact_phone") @db.VarChar(20)
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at") @db.DateTime
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.DateTime

  // Relaciones
  students   Student[]
  agreements Agreement[]

  @@index([isActive])
  @@map("schools")
}

/// Convenios con colegios
model Agreement {
  id            Int       @id @default(autoincrement()) @db.UnsignedInt
  schoolId      Int       @map("school_id") @db.UnsignedInt
  agreementCode String    @unique @map("agreement_code") @db.VarChar(30)
  discountType  String    @map("discount_type") @db.VarChar(20)
  discountValue Decimal   @map("discount_value") @db.Decimal(10, 2)
  startDate     DateTime  @map("start_date") @db.Date
  endDate       DateTime? @map("end_date") @db.Date
  isActive      Boolean   @default(true) @map("is_active")
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.DateTime
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.DateTime

  // Relaciones
  school      School       @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  enrollments Enrollment[]

  @@index([schoolId])
  @@index([isActive])
  @@index([startDate, endDate])
  @@map("agreements")
}

// ============================================
// MÓDULO: NOTIFICACIONES
// ============================================

/// Registro de emails enviados
model NotificationEmailLog {
  id               Int       @id @default(autoincrement()) @db.UnsignedInt
  recipientEmail   String    @map("recipient_email") @db.VarChar(150)
  recipientUserId  Int?      @map("recipient_user_id") @db.UnsignedInt
  subject          String    @db.VarChar(255)
  body             String    @db.Text
  emailType        String    @map("email_type") @db.VarChar(50)
  status           String    @default("PENDING") @db.VarChar(20)
  sentAt           DateTime? @map("sent_at") @db.DateTime
  errorMessage     String?   @map("error_message") @db.Text
  retryCount       Int       @default(0) @map("retry_count")
  metadata         Json?
  createdAt        DateTime  @default(now()) @map("created_at") @db.DateTime

  // Relaciones
  recipientUser User? @relation(fields: [recipientUserId], references: [id], onDelete: SetNull)

  @@index([recipientEmail])
  @@index([recipientUserId])
  @@index([status])
  @@index([emailType])
  @@index([sentAt])
  @@map("notification_email_logs")
}
