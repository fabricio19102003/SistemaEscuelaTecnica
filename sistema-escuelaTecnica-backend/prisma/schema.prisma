// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// USUARIOS Y ROLES
// ============================================

model User {
  id               Int       @id @default(autoincrement()) @db.UnsignedInt
  username         String?   @unique @db.VarChar(50) // New field for login
  email            String?   @unique @db.VarChar(150) // Made optional as requested "not emails" for login, but good to keep
  passwordHash     String    @map("password_hash") @db.VarChar(255)
  firstName        String    @map("first_name") @db.VarChar(100)
  paternalSurname  String    @map("paternal_surname") @db.VarChar(100)
  maternalSurname  String?   @map("maternal_surname") @db.VarChar(100)
  phone            String?   @db.VarChar(20)
  profileImageUrl  String?   @map("profile_image_url") @db.VarChar(500)
  isActive         Boolean   @default(true) @map("is_active")
  emailVerified    Boolean   @default(false) @map("email_verified")
  lastLoginAt      DateTime? @map("last_login_at") 
  createdAt        DateTime  @default(now()) @map("created_at") 
  updatedAt        DateTime  @updatedAt @map("updated_at") 
  deletedAt        DateTime? @map("deleted_at") 

  // Relaciones
  userRoles               UserRole[]
  student                 Student?
  teacher                 Teacher?
  guardian                Guardian?
  certificatesIssued      Certificate[]             @relation("CertificateIssuer")
  paymentsReceived        PaymentRecord[]           @relation("PaymentReceiver")
  cashRegistersOpened     CashRegister[]            @relation("CashRegisterOpener")
  cashRegistersClosed     CashRegister[]            @relation("CashRegisterCloser")
  cashFlowsCreated        CashFlow[]
  notificationEmailLogs   NotificationEmailLog[]
  enrollmentsCreated      Enrollment[]              @relation("EnrollmentCreator")
  notifications           Notification[]            // New relation for in-app notifications

  @@index([email])
  @@index([isActive])
  @@map("users")
}

model Role {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  name        String   @unique @db.VarChar(50)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") 

  // Relaciones
  userRoles UserRole[]

  @@map("roles")
}

model UserRole {
  id         Int      @id @default(autoincrement()) @db.UnsignedInt
  userId     Int      @map("user_id") @db.UnsignedInt
  roleId     Int      @map("role_id") @db.UnsignedInt
  assignedAt DateTime @default(now()) @map("assigned_at") 

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// ============================================
// ESTUDIANTES Y TUTORES
// ============================================

model Student {
  id                     Int       @id @default(autoincrement()) @db.UnsignedInt
  userId                 Int       @unique @map("user_id") @db.UnsignedInt
  registrationCode       String    @unique @map("registration_code") @db.VarChar(20)
  documentType           DocumentType @map("document_type")
  documentNumber         String    @map("document_number") @db.VarChar(20)
  dateOfBirth            DateTime  @map("date_of_birth") @db.Date
  gender                 Gender?
  address                String?   @db.VarChar(255)
  previousSchool         String?   @map("previous_school") @db.VarChar(200)
  schoolId               Int?      @map("school_id") @db.UnsignedInt
  emergencyContactName   String?   @map("emergency_contact_name") @db.VarChar(150)
  emergencyContactPhone  String?   @map("emergency_contact_phone") @db.VarChar(20)
  medicalNotes           String?   @map("medical_notes") @db.Text
  enrollmentStatus       EnrollmentGeneralStatus @map("enrollment_status")
  createdAt              DateTime  @default(now()) @map("created_at") 
  updatedAt              DateTime  @updatedAt @map("updated_at") 
  deletedAt              DateTime? @map("deleted_at") 

  // Relaciones
  user            User              @relation(fields: [userId], references: [id], onDelete: Restrict)
  school          School?           @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  studentGuardians StudentGuardian[]
  enrollments     Enrollment[]
  debtRecords     DebtRecord[]

  @@index([userId])
  @@index([documentNumber])
  @@index([registrationCode])
  @@index([schoolId])
  @@index([enrollmentStatus])
  @@map("students")
}

model Guardian {
  id             Int          @id @default(autoincrement()) @db.UnsignedInt
  userId         Int          @unique @map("user_id") @db.UnsignedInt
  documentType   DocumentType @map("document_type")
  documentNumber String       @map("document_number") @db.VarChar(20)
  relationship   Relationship
  occupation     String?      @db.VarChar(100)
  workplace      String?      @db.VarChar(150)
  createdAt      DateTime     @default(now()) @map("created_at") 
  updatedAt      DateTime     @updatedAt @map("updated_at") 
  deletedAt      DateTime?    @map("deleted_at") 

  // Relaciones
  user             User              @relation(fields: [userId], references: [id], onDelete: Restrict)
  studentGuardians StudentGuardian[]

  @@index([userId])
  @@index([documentNumber])
  @@map("guardians")
}

model StudentGuardian {
  id         Int      @id @default(autoincrement()) @db.UnsignedInt
  studentId  Int      @map("student_id") @db.UnsignedInt
  guardianId Int      @map("guardian_id") @db.UnsignedInt
  isPrimary  Boolean  @default(false) @map("is_primary")
  canPickup  Boolean  @default(true) @map("can_pickup")
  createdAt  DateTime @default(now()) @map("created_at") 

  // Relaciones
  student  Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  guardian Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)

  @@unique([studentId, guardianId])
  @@index([studentId])
  @@index([guardianId])
  @@map("student_guardians")
}

// ============================================
// DOCENTES
// ============================================

model Teacher {
  id             Int          @id @default(autoincrement()) @db.UnsignedInt
  userId         Int          @unique @map("user_id") @db.UnsignedInt
  documentType   DocumentType @map("document_type")
  documentNumber String       @map("document_number") @db.VarChar(20)
  specialization String?      @db.VarChar(150)
  hireDate       DateTime     @map("hire_date") @db.Date
  contractType   ContractType @map("contract_type")
  hourlyRate     Decimal?     @map("hourly_rate") @db.Decimal(10, 2)
  cvUrl          String?      @map("cv_url") @db.VarChar(500)
  isActive       Boolean      @default(true) @map("is_active")
  createdAt      DateTime     @default(now()) @map("created_at") 
  updatedAt      DateTime     @updatedAt @map("updated_at") 
  deletedAt      DateTime?    @map("deleted_at") 

  // Relaciones
  user         User         @relation(fields: [userId], references: [id], onDelete: Restrict)
  groups       Group[]
  courses      Course[]     // New relation to Course
  attendances  Attendance[] @relation("AttendanceRecorder")
  grades       Grade[]      @relation("GradeRecorder")
  reportCards  ReportCard[] @relation("ReportCardIssuer")

  @@index([userId])
  @@index([documentNumber])
  @@index([isActive])
  @@map("teachers")
}

// ============================================
// ESTRUCTURA ACADÉMICA
// ============================================

model Course {
  id             Int       @id @default(autoincrement()) @db.UnsignedInt
  name           String    @db.VarChar(150)
  code           String    @unique @db.VarChar(20) // Now auto-generated
  description    String?   @db.Text

  durationMonths Int?      @map("duration_months")
  imageUrl       String?   @map("image_url") @db.VarChar(500)
  isActive       Boolean   @default(true) @map("is_active")
  
  teacherId      Int?      @map("teacher_id") @db.UnsignedInt
  classroomId    Int?      @map("classroom_id") @db.UnsignedInt

  createdAt      DateTime  @default(now()) @map("created_at") 
  updatedAt      DateTime  @updatedAt @map("updated_at") 

  // Relaciones
  teacher        Teacher?    @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  classroom      Classroom?  @relation(fields: [classroomId], references: [id], onDelete: SetNull)
  levels         Level[]
  schedules      Schedule[]

  @@index([code])
  @@index([isActive])
  @@index([teacherId])
  @@index([classroomId])
  @@map("courses")
}

model Classroom {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  name        String   @unique @db.VarChar(100)
  capacity    Int
  location    String?  @db.VarChar(150)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  courses     Course[]

  @@map("classrooms")
}

model Level {
  id            Int       @id @default(autoincrement()) @db.UnsignedInt
  courseId      Int       @map("course_id") @db.UnsignedInt
  name          String    @db.VarChar(100)
  code          String    @db.VarChar(20)
  orderIndex    Int       @map("order_index")
  description   String?   @db.Text
  durationWeeks Int       @map("duration_weeks")
  totalHours    Int       @map("total_hours")
  basePrice     Decimal   @map("base_price") @db.Decimal(10, 2)
  objectives    String?   @db.Text
  requirements  String?   @db.Text
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at") 
  updatedAt     DateTime  @updatedAt @map("updated_at") 

  // Relaciones
  course Course  @relation(fields: [courseId], references: [id], onDelete: Restrict)
  groups Group[]

  @@unique([courseId, code])
  @@index([courseId])
  @@index([isActive])
  @@map("levels")
}

model Group {
  id              Int         @id @default(autoincrement()) @db.UnsignedInt
  levelId         Int         @map("level_id") @db.UnsignedInt
  teacherId       Int         @map("teacher_id") @db.UnsignedInt
  name            String      @db.VarChar(100)
  code            String      @unique @db.VarChar(30)
  startDate       DateTime    @map("start_date") @db.Date
  endDate         DateTime    @map("end_date") @db.Date
  maxCapacity     Int         @map("max_capacity")
  minCapacity     Int         @default(5) @map("min_capacity")
  currentEnrolled Int         @default(0) @map("current_enrolled")
  status          GroupStatus @default(DRAFT)
  classroom       String?     @db.VarChar(50) // Legacy or specific override? Keeping for now.
  notes           String?     @db.Text
  createdAt       DateTime    @default(now()) @map("created_at") 
  updatedAt       DateTime    @updatedAt @map("updated_at") 

  // Relaciones
  level       Level        @relation(fields: [levelId], references: [id], onDelete: Restrict)
  teacher     Teacher      @relation(fields: [teacherId], references: [id], onDelete: Restrict)
  schedules   Schedule[]
  enrollments Enrollment[]

  @@index([code])
  @@index([levelId])
  @@index([teacherId])
  @@index([status])
  @@index([startDate])
  @@map("groups")
}

model Schedule {
  id        Int       @id @default(autoincrement()) @db.UnsignedInt
  groupId   Int?      @map("group_id") @db.UnsignedInt // Made optional
  courseId  Int?      @map("course_id") @db.UnsignedInt // Added
  dayOfWeek DayOfWeek @map("day_of_week")
  startTime DateTime  @map("start_time") @db.Time
  endTime   DateTime  @map("end_time") @db.Time
  createdAt DateTime  @default(now()) @map("created_at") 

  // Relaciones
  group   Group?   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  course  Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([courseId])
  @@map("schedules")
}

// ============================================
// MATRÍCULAS Y PROCESO ACADÉMICO
// ============================================

model Enrollment {
  id                 Int              @id @default(autoincrement()) @db.UnsignedInt
  studentId          Int              @map("student_id") @db.UnsignedInt
  groupId            Int              @map("group_id") @db.UnsignedInt
  enrollmentDate     DateTime         @map("enrollment_date") @db.Date
  startDate          DateTime         @map("start_date") @db.Date
  endDate            DateTime?        @map("end_date") @db.Date
  status             EnrollmentStatus @default(PENDING)
  agreedPrice        Decimal          @map("agreed_price") @db.Decimal(10, 2)
  discountPercentage Decimal          @default(0.00) @map("discount_percentage") @db.Decimal(5, 2)
  agreementId        Int?             @map("agreement_id") @db.UnsignedInt
  enrollmentNotes    String?          @map("enrollment_notes") @db.Text
  createdAt          DateTime         @default(now()) @map("created_at") 
  updatedAt          DateTime         @updatedAt @map("updated_at") 
  deletedAt          DateTime?        @map("deleted_at") 

  // Relaciones
  student     Student       @relation(fields: [studentId], references: [id], onDelete: Restrict)
  group       Group         @relation(fields: [groupId], references: [id], onDelete: Restrict)
  agreement   Agreement?    @relation(fields: [agreementId], references: [id], onDelete: SetNull)
  attendances Attendance[]
  grades      Grade[]
  reportCards ReportCard[]
  certificates Certificate[]
  invoices    Invoice[]
  
  createdById Int?            @map("created_by") @db.UnsignedInt
  createdBy   User?           @relation("EnrollmentCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([studentId])
  @@index([groupId])
  @@index([status])
  @@index([enrollmentDate])
  @@index([agreementId])
  @@index([createdById])
  @@map("enrollments")
}

model Attendance {
  id             Int              @id @default(autoincrement()) @db.UnsignedInt
  enrollmentId   Int              @map("enrollment_id") @db.UnsignedInt
  attendanceDate DateTime         @map("attendance_date") @db.Date
  status         AttendanceStatus
  arrivalTime    DateTime?        @map("arrival_time") @db.Time
  notes          String?          @db.Text
  recordedBy     Int?             @map("recorded_by") @db.UnsignedInt
  createdAt      DateTime         @default(now()) @map("created_at") 
  updatedAt      DateTime         @updatedAt @map("updated_at") 

  // Relaciones
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  recorder   Teacher?   @relation("AttendanceRecorder", fields: [recordedBy], references: [id], onDelete: SetNull)

  @@unique([enrollmentId, attendanceDate])
  @@index([enrollmentId])
  @@index([attendanceDate])
  @@index([status])
  @@map("attendances")
}

model Grade {
  id             Int            @id @default(autoincrement()) @db.UnsignedInt
  enrollmentId   Int            @map("enrollment_id") @db.UnsignedInt
  evaluationName String         @map("evaluation_name") @db.VarChar(150)
  evaluationType EvaluationType @map("evaluation_type")
  progressTest   Decimal?       @map("progress_test") @db.Decimal(5, 2)
  classPerformance Decimal?     @map("class_performance") @db.Decimal(5, 2)
  gradeValue     Decimal        @map("grade_value") @db.Decimal(5, 2)
  maxGrade       Decimal        @default(20.00) @map("max_grade") @db.Decimal(5, 2)
  weight         Decimal        @default(1.00) @db.Decimal(5, 2)
  evaluationDate DateTime       @map("evaluation_date") @db.Date
  comments       String?        @db.Text
  recordedBy     Int?           @map("recorded_by") @db.UnsignedInt
  createdAt      DateTime       @default(now()) @map("created_at") 
  updatedAt      DateTime       @updatedAt @map("updated_at") 

  // Relaciones
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  recorder   Teacher?   @relation("GradeRecorder", fields: [recordedBy], references: [id], onDelete: SetNull)

  @@index([enrollmentId])
  @@index([evaluationType])
  @@index([evaluationDate])
  @@map("grades")
}

model ReportCard {
  id                   Int              @id @default(autoincrement()) @db.UnsignedInt
  enrollmentId         Int              @map("enrollment_id") @db.UnsignedInt
  periodName           String           @map("period_name") @db.VarChar(100)
  periodStart          DateTime         @map("period_start") @db.Date
  periodEnd            DateTime         @map("period_end") @db.Date
  finalGrade           Decimal          @map("final_grade") @db.Decimal(5, 2)
  maxGrade             Decimal          @default(20.00) @map("max_grade") @db.Decimal(5, 2)
  attendancePercentage Decimal?         @map("attendance_percentage") @db.Decimal(5, 2)
  absences             Int              @default(0) // New field for report card
  teacherComments      String?          @map("teacher_comments") @db.Text
  status               ReportCardStatus
  issuedDate           DateTime?        @map("issued_date") @db.Date
  issuedBy             Int?             @map("issued_by") @db.UnsignedInt
  createdAt            DateTime         @default(now()) @map("created_at") 
  updatedAt            DateTime         @updatedAt @map("updated_at") 

  // Relaciones
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  issuer     Teacher?   @relation("ReportCardIssuer", fields: [issuedBy], references: [id], onDelete: SetNull)

  @@index([enrollmentId])
  @@index([status])
  @@index([issuedDate])
  @@map("report_cards")
}

model Certificate {
  id                   Int       @id @default(autoincrement()) @db.UnsignedInt
  enrollmentId         Int       @map("enrollment_id") @db.UnsignedInt
  certificateNumber    String    @unique @map("certificate_number") @db.VarChar(50)
  studentName          String    @map("student_name") @db.VarChar(200)
  levelName            String    @map("level_name") @db.VarChar(150)
  courseName           String    @map("course_name") @db.VarChar(150)
  issueDate            DateTime  @map("issue_date") @db.Date
  completionDate       DateTime  @map("completion_date") @db.Date
  finalGrade           Decimal   @map("final_grade") @db.Decimal(5, 2)
  attendancePercentage Decimal   @map("attendance_percentage") @db.Decimal(5, 2)
  totalHours           Int       @map("total_hours")
  certificateFileUrl   String?   @map("certificate_file_url") @db.VarChar(500)
  issuedBy             Int?      @map("issued_by") @db.UnsignedInt
  notes                String?   @db.Text
  createdAt            DateTime  @default(now()) @map("created_at") 

  // Relaciones
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Restrict)
  issuer     User?      @relation("CertificateIssuer", fields: [issuedBy], references: [id], onDelete: SetNull)

  @@index([certificateNumber])
  @@index([enrollmentId])
  @@index([issueDate])
  @@map("certificates")
}

// ============================================
// CONVENIOS Y COLEGIOS
// ============================================

model School {
  id            Int       @id @default(autoincrement()) @db.UnsignedInt
  name          String    @db.VarChar(200)
  code          String    @unique @db.VarChar(30)
  sieCode       String?   @unique @map("sie_code") @db.VarChar(20)
  directorName  String?   @map("director_name") @db.VarChar(150)
  directorPhone String?   @map("director_phone") @db.VarChar(20)
  levels        Json?     @map("levels")
  address       String?   @db.VarChar(255)
  district      String?   @db.VarChar(100)
  city          String?   @db.VarChar(100)
  phone         String?   @db.VarChar(20)
  email         String?   @db.VarChar(150)
  contactPerson String?   @map("contact_person") @db.VarChar(150)
  contactPhone  String?   @map("contact_phone") @db.VarChar(20)
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at") 
  updatedAt     DateTime  @updatedAt @map("updated_at") 

  agreementId   Int?      @map("agreement_id") @db.UnsignedInt
  
  // Relaciones
  students   Student[]
  agreement  Agreement? @relation(fields: [agreementId], references: [id], onDelete: SetNull)

  @@index([code])
  @@index([isActive])
  @@index([agreementId])
  @@map("schools")
}

model Agreement {
  id            Int          @id @default(autoincrement()) @db.UnsignedInt
  name          String       @db.VarChar(150) // New field for Agreement Name
  agreementCode String       @unique @map("agreement_code") @db.VarChar(30)
  discountType  DiscountType @map("discount_type")
  discountValue Decimal      @map("discount_value") @db.Decimal(10, 2)
  startDate     DateTime     @map("start_date") @db.Date
  endDate       DateTime?    @map("end_date") @db.Date
  isActive      Boolean      @default(true) @map("is_active")
  notes         String?      @db.Text
  createdAt     DateTime     @default(now()) @map("created_at") 
  updatedAt     DateTime     @updatedAt @map("updated_at") 

  // Relaciones
  schools     School[]
  enrollments Enrollment[]

  @@index([agreementCode])
  @@index([isActive])
  @@index([startDate, endDate])
  @@map("agreements")
}

// ============================================
// ADMINISTRACIÓN FINANCIERA
// ============================================

model Invoice {
  id                   Int           @id @default(autoincrement()) @db.UnsignedInt
  enrollmentId         Int?          @map("enrollment_id") @db.UnsignedInt
  invoiceNumber        String        @unique @map("invoice_number") @db.VarChar(30)
  issueDate            DateTime      @map("issue_date") @db.Date
  dueDate              DateTime      @map("due_date") @db.Date
  subtotal             Decimal       @db.Decimal(10, 2)
  discountAmount       Decimal       @default(0.00) @map("discount_amount") @db.Decimal(10, 2)
  taxAmount            Decimal       @default(0.00) @map("tax_amount") @db.Decimal(10, 2)
  totalAmount          Decimal       @map("total_amount") @db.Decimal(10, 2)
  amountPaid           Decimal       @default(0.00) @map("amount_paid") @db.Decimal(10, 2)
  balance              Decimal       @db.Decimal(10, 2)
  status               InvoiceStatus @default(PENDING)
  paymentDeadlineDays  Int           @default(30) @map("payment_deadline_days")
  notes                String?       @db.Text
  createdAt            DateTime      @default(now()) @map("created_at") 
  updatedAt            DateTime      @updatedAt @map("updated_at") 
  deletedAt            DateTime?     @map("deleted_at") 

  // Relaciones
  enrollment      Enrollment?      @relation(fields: [enrollmentId], references: [id], onDelete: SetNull)
  paymentRecords  PaymentRecord[]

  @@index([invoiceNumber])
  @@index([enrollmentId])
  @@index([status])
  @@index([dueDate])
  @@index([issueDate])
  @@map("invoices")
}

model PaymentRecord {
  id              Int           @id @default(autoincrement()) @db.UnsignedInt
  invoiceId       Int           @map("invoice_id") @db.UnsignedInt
  paymentDate     DateTime      @map("payment_date") @db.Date
  amount          Decimal       @db.Decimal(10, 2)
  paymentMethod   PaymentMethod @map("payment_method")
  referenceNumber String?       @map("reference_number") @db.VarChar(100)
  notes           String?       @db.Text
  receivedBy      Int?          @map("received_by") @db.UnsignedInt
  createdAt       DateTime      @default(now()) @map("created_at") 

  // Relaciones
  invoice   Invoice    @relation(fields: [invoiceId], references: [id], onDelete: Restrict)
  receiver  User?      @relation("PaymentReceiver", fields: [receivedBy], references: [id], onDelete: SetNull)
  cashFlows CashFlow[]

  @@index([invoiceId])
  @@index([paymentDate])
  @@index([paymentMethod])
  @@map("payment_records")
}

model DebtRecord {
  id              Int            @id @default(autoincrement()) @db.UnsignedInt
  studentId       Int            @map("student_id") @db.UnsignedInt
  totalDebt       Decimal        @map("total_debt") @db.Decimal(10, 2)
  oldestDebtDate  DateTime?      @map("oldest_debt_date") @db.Date
  lastPaymentDate DateTime?      @map("last_payment_date") @db.Date
  paymentPlan     String?        @map("payment_plan") @db.Text
  status          DebtStatus
  createdAt       DateTime       @default(now()) @map("created_at") 
  updatedAt       DateTime       @updatedAt @map("updated_at") 

  // Relaciones
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([status])
  @@map("debt_records")
}

model CashRegister {
  id              Int               @id @default(autoincrement()) @db.UnsignedInt
  openedBy        Int               @map("opened_by") @db.UnsignedInt
  openedAt        DateTime          @map("opened_at") 
  closedBy        Int?              @map("closed_by") @db.UnsignedInt
  closedAt        DateTime?         @map("closed_at") 
  openingBalance  Decimal           @map("opening_balance") @db.Decimal(10, 2)
  closingBalance  Decimal?          @map("closing_balance") @db.Decimal(10, 2)
  expectedBalance Decimal?          @map("expected_balance") @db.Decimal(10, 2)
  difference      Decimal?          @db.Decimal(10, 2)
  status          CashRegisterStatus @default(OPEN)
  notes           String?           @db.Text
  createdAt       DateTime          @default(now()) @map("created_at") 

  // Relaciones
  opener    User       @relation("CashRegisterOpener", fields: [openedBy], references: [id], onDelete: Restrict)
  closer    User?      @relation("CashRegisterCloser", fields: [closedBy], references: [id], onDelete: SetNull)
  cashFlows CashFlow[]

  @@index([openedBy])
  @@index([openedAt])
  @@index([status])
  @@map("cash_registers")
}

model CashFlow {
  id              Int             @id @default(autoincrement()) @db.UnsignedInt
  cashRegisterId  Int             @map("cash_register_id") @db.UnsignedInt
  transactionType TransactionType @map("transaction_type")
  amount          Decimal         @db.Decimal(10, 2)
  category        String          @db.VarChar(100)
  description     String?         @db.Text
  paymentRecordId Int?            @map("payment_record_id") @db.UnsignedInt
  reference       String?         @db.VarChar(100)
  createdBy       Int             @map("created_by") @db.UnsignedInt
  createdAt       DateTime        @default(now()) @map("created_at") 

  // Relaciones
  cashRegister  CashRegister   @relation(fields: [cashRegisterId], references: [id], onDelete: Restrict)
  paymentRecord PaymentRecord? @relation(fields: [paymentRecordId], references: [id], onDelete: SetNull)
  creator       User           @relation(fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([cashRegisterId])
  @@index([transactionType])
  @@index([createdAt])
  @@map("cash_flows")
}

// ============================================
// NOTIFICACIONES
// ============================================

model NotificationEmailLog {
  id              Int                   @id @default(autoincrement()) @db.UnsignedInt
  recipientEmail  String                @map("recipient_email") @db.VarChar(150)
  recipientUserId Int?                  @map("recipient_user_id") @db.UnsignedInt
  subject         String                @db.VarChar(255)
  body            String                @db.Text
  emailType       String                @map("email_type") @db.VarChar(50)
  status          NotificationStatus    @default(PENDING)
  sentAt          DateTime?             @map("sent_at") 
  errorMessage    String?               @map("error_message") @db.Text
  retryCount      Int                   @default(0) @map("retry_count")
  metadata        Json?
  createdAt       DateTime              @default(now()) @map("created_at") 

  // Relaciones
  recipientUser User? @relation(fields: [recipientUserId], references: [id], onDelete: SetNull)

  @@index([recipientEmail])
  @@index([recipientUserId])
  @@index([status])
  @@index([emailType])
  @@index([sentAt])
  @@map("notification_email_logs")
}

model Notification {
  id        Int      @id @default(autoincrement()) @db.UnsignedInt
  userId    Int      @map("user_id") @db.UnsignedInt
  title     String   @db.VarChar(150)
  message   String   @db.Text
  type      String   @default("INFO") // INFO, WARNING, SUCCESS, ERROR
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// ============================================
// TEMPLATES DE HORARIOS
// ============================================

model ScheduleTemplate {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  
  items       ScheduleTemplateItem[]

  @@map("schedule_templates")
}

model ScheduleTemplateItem {
  id         Int              @id @default(autoincrement()) @db.UnsignedInt
  templateId Int              @map("template_id") @db.UnsignedInt
  dayOfWeek  DayOfWeek        @map("day_of_week")
  startTime  DateTime         @map("start_time") @db.Time
  endTime    DateTime         @map("end_time") @db.Time

  template   ScheduleTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("schedule_template_items")
}

// ============================================
// ENUMS
// ============================================

enum DocumentType {
  DNI
  CE
  PASSPORT
  OTHER
}

enum Gender {
  M
  F
  OTHER
}

enum Relationship {
  FATHER
  MOTHER
  LEGAL_GUARDIAN
  OTHER
}

enum ContractType {
  FULL_TIME
  PART_TIME
  FREELANCE
}

enum EnrollmentGeneralStatus {
  ACTIVE
  INACTIVE
  GRADUATED
  RETIRADO
  ABANDONO
  NO_INCORPORADO
}

enum GroupStatus {
  DRAFT
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum EnrollmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
  SUSPENDED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum EvaluationType {
  SPEAKING
  LISTENING
  READING
  WRITING
  VOCABULARY
  GRAMMAR
  QUIZ
  EXAM
  HOMEWORK
  PROJECT
  PARTICIPATION
  OTHER
}

enum ReportCardStatus {
  IN_PROGRESS
  APPROVED
  FAILED
  INCOMPLETE
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum InvoiceStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  CHEQUE
  OTHER
}

enum DebtStatus {
  CURRENT
  OVERDUE
  IN_COLLECTION
  RESOLVED
}

enum CashRegisterStatus {
  OPEN
  CLOSED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

